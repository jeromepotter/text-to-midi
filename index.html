<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TEXT TO MIDI GENERATOR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background-color: #000000; 
            color: #ffffff; 
            font-family: 'Poppins', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
        }

        .wrapper { 
            width: 100%; 
            max-width: 700px;
            display: flex;
            flex-direction: column;
            height: 90vh; 
        }

        h1 { 
            font-weight: 600; 
            font-size: 1.2rem;
            letter-spacing: 2px; 
            text-align: center; 
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        /* --- HOW TO SECTION --- */
        .how-to-toggle {
            text-align: center;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }
        .how-to-toggle:hover { color: #fff; }

        .how-to-content {
            display: none;
            background: #111;
            padding: 20px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #ccc;
            border: 1px solid #333;
        }
        .how-to-content h3 {
            font-size: 0.8rem;
            color: #fff;
            margin: 15px 0 5px 0;
            text-transform: uppercase;
            border-bottom: 1px dashed #333;
            padding-bottom: 5px;
        }
        .how-to-content h3:first-child { margin-top: 0; }
        
        .how-to-content ul { padding-left: 15px; margin: 0; }
        .how-to-content li { margin-bottom: 8px; }
        
        .prompt-block {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 5px;
            font-family: monospace;
            color: #888;
            font-size: 0.75rem;
        }
        .prompt-title { color: #fff; font-size: 0.75rem; font-weight: bold; margin-top: 10px; display: block; }

        /* --- SETTINGS BAR --- */
        .settings-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        .settings-group { flex: 1; }
        
        .settings-label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 8px; 
        }
        
        .api-link { 
            color: #fff; 
            text-decoration: none; 
            cursor: pointer; 
            opacity: 0.5; 
            font-size: 0.65rem;
        }
        .api-link:hover { 
            text-decoration: underline; 
            opacity: 1; 
        }

        .settings-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #aaa;
            padding: 8px;
            font-size: 0.8rem;
            font-family: monospace;
            outline: none;
        }
        .settings-input:focus { border-color: #666; color: #fff; }

        /* --- CHAT LOG --- */
        #chatContainer {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #222;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #050505;
        }
        
        .msg { padding: 10px 15px; font-size: 0.9rem; line-height: 1.5; max-width: 85%; }
        .msg.user { align-self: flex-end; background: #1a1a1a; border: 1px solid #333; color: #eee; }
        .msg.system { align-self: flex-start; color: #888; font-family: monospace; font-size: 0.75rem; border-left: 2px solid #333; }
        .msg.error { color: #f55; border-color: #f55; }

        /* --- INPUT AREA --- */
        .input-area { position: relative; }
        
        textarea { 
            width: 100%; 
            background: #000; 
            border: 1px solid #333; 
            color: #fff; 
            padding: 15px; 
            min-height: 80px;
            max-height: 300px;
            font-size: 0.9rem; 
            font-family: 'Poppins', sans-serif;
            outline: none; 
            resize: vertical;
            display: block;
            box-sizing: border-box;
        }
        textarea:focus { border-color: #fff; }

        .btn-row { display: flex; gap: 10px; margin-top: 10px; }

        button { 
            flex: 1; padding: 15px; background: #fff; color: #000; border: none; 
            font-weight: 600; font-size: 0.9rem; letter-spacing: 1px; 
            text-transform: uppercase; cursor: pointer; 
            transition: all 0.2s ease;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; }
        
        #resetBtn { flex: 0 0 auto; background: #000; color: #f55; border: 1px solid #333; width: auto; padding: 0 20px; }
        #resetBtn:hover { border-color: #f55; background: #100; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

<div class="wrapper">
    <h1>Text to MIDI Generator</h1>
    
    <div class="how-to-toggle" onclick="toggleGuide()">[ HOW TO USE ]</div>
    <div id="guide" class="how-to-content">
        <h3>1. API KEYS</h3>
        Get a key from Google AI Studio. If stuck, reset session or get a new key.
        
        <h3>2. SETUP</h3>
        <ul>
            <li><strong>DAW:</strong> Enable "IAC Driver" (Mac) or "LoopMIDI" (PC). Arm your DAW tracks & Monitor IN.</li>
            <li><strong>HARDWARE:</strong> Connect your MIDI Interface via USB. This tool sends raw MIDI to all 16 channels.</li>
        </ul>

        <h3>3. PROMPT EXAMPLES</h3>
        <span class="prompt-title">BASIC</span>
        <div class="prompt-block">"On Channel 1, play a C Major chord progression. On Channel 2, play a simple melody in C Major."</div>
    </div>

    <div class="settings-bar">
        <div class="settings-group">
            <span class="settings-label">
                1. API KEY
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">(GET KEY)</a>
            </span>
            <input type="password" id="apiKey" class="settings-input" placeholder="Paste Key Here...">
        </div>
        <div class="settings-group">
            <span class="settings-label">
                2. MIDI OUTPUT
                <span style="opacity: 0.5;">(Select Driver)</span>
            </span>
            <select id="midiOut" class="settings-input"><option>Scanning...</option></select>
        </div>
    </div>

    <div id="chatContainer">
        <div class="msg system">System Ready. Waiting for input...</div>
    </div>

    <div class="input-area">
        <textarea id="prompt" placeholder="Describe the music..."></textarea>
        <div class="btn-row">
            <button id="resetBtn" onclick="resetSession()" title="Clear History">RESET</button>
            <button id="generateBtn" onclick="generateMusic()">SEND COMMAND</button>
        </div>
    </div>
</div>

<script>
    let midiOutput = null;
    let chatHistory = []; 
    let loadingInterval = null;

    function toggleGuide() {
        const guide = document.getElementById('guide');
        const btn = document.querySelector('.how-to-toggle');
        if (getComputedStyle(guide).display === 'none') {
            guide.style.display = 'block';
            btn.innerText = '[ CLOSE GUIDE ]';
        } else {
            guide.style.display = 'none';
            btn.innerText = '[ HOW TO USE ]';
        }
    }

    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(access => {
            const outputs = Array.from(access.outputs.values());
            const select = document.getElementById('midiOut');
            select.innerHTML = '';
            
            if (outputs.length === 0) {
                select.innerHTML = '<option value="">No Ports Found</option>';
                return;
            }

            outputs.forEach(port => {
                const option = document.createElement('option');
                option.value = port.id;
                option.text = port.name;
                if (port.name.toLowerCase().includes("iac") || 
                    port.name.toLowerCase().includes("loop")) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            updatePort();
            select.addEventListener('change', updatePort);
        }).catch(e => appendMsg("system error", "MIDI Access Denied: " + e));
    }

    function updatePort() {
        const id = document.getElementById('midiOut').value;
        if (!id) return;
        navigator.requestMIDIAccess().then(a => {
            midiOutput = a.outputs.get(id);
            if (midiOutput) appendMsg("system", `Connected to: ${midiOutput.name}`);
        });
    }

    function appendMsg(role, text) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function startLoading() {
        let dots = 0;
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        
        loadingInterval = setInterval(() => {
            dots = (dots + 1) % 4; 
            let text = "WORKING";
            for(let i=0; i<dots; i++) text += ".";
            btn.innerText = text;
        }, 400); 
    }

    function stopLoading(success = false) {
        clearInterval(loadingInterval);
        const btn = document.getElementById('generateBtn');
        
        if (success) {
            const originalText = "SEND COMMAND";
            const originalColor = "#fff";
            
            btn.innerText = "SUCCESS!";
            btn.style.backgroundColor = "#4CAF50"; // Green
            btn.style.color = "#fff";
            
            // Revert button after 2 seconds
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = originalColor;
                btn.style.color = "#000";
                btn.disabled = false;
            }, 2000); 
        } else {
            btn.innerText = "SEND COMMAND";
            btn.disabled = false;
        }
    }

    async function generateMusic() {
        const key = document.getElementById('apiKey').value.trim();
        const userPrompt = document.getElementById('prompt').value.trim();
        
        if (!key) return appendMsg("system error", "Please enter API Key.");
        if (!midiOutput) return appendMsg("system error", "Select MIDI Output.");
        if (!userPrompt) return;

        appendMsg("user", userPrompt);
        document.getElementById('prompt').value = ""; 
        startLoading();

        const systemInstruction = `
        You are a Virtuosic MIDI Composer. 
        Output only valid JSON. NO Markdown.
        Format: { "tracks": [ { "channel": 1-16, "notes": [ { "pitch": 60, "velocity": 100, "start_time": 0.0, "duration": 1.0 } ] } ] }
        Start time is in seconds.
        `;

        if (chatHistory.length === 0) {
            chatHistory.push({
                role: "user",
                parts: [{ text: systemInstruction + "\n\nUser Request: " + userPrompt }]
            });
        } else {
            chatHistory.push({
                role: "user",
                parts: [{ text: userPrompt }]
            });
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: chatHistory })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error.message || "API Error");
            }

            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            
            chatHistory.push({
                role: "model",
                parts: [{ text: rawText }]
            });

            const jsonMatch = rawText.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error("Invalid Data Received");
            
            const musicData = JSON.parse(jsonMatch[0]);
            playSequence(musicData);
            
            appendMsg("system", "MIDI Sent âœ“");
            stopLoading(true);

        } catch (e) {
            appendMsg("system error", e.message);
            chatHistory.pop(); 
            stopLoading(false);
        }
    }

    function resetSession() {
        chatHistory = [];
        document.getElementById('chatContainer').innerHTML = '<div class="msg system">Session Reset. Waiting for input...</div>';
    }

    function playSequence(data) {
        const now = performance.now();
        if (!data.tracks) return;

        let totalNotes = 0;
        let maxDuration = 0;

        data.tracks.forEach(track => {
            const channel = Math.max(0, Math.min(15, (track.channel || 1) - 1));
            track.notes.forEach(note => {
                const start = now + (note.start_time * 1000);
                const end = start + (note.duration * 1000);
                
                // Track song length
                if (note.start_time + note.duration > maxDuration) {
                    maxDuration = note.start_time + note.duration;
                }

                midiOutput.send([0x90 + channel, note.pitch, note.velocity || 100], start);
                midiOutput.send([0x80 + channel, note.pitch, 0], end);
                totalNotes++;
            });
        });

        appendMsg("system", `Playing ${maxDuration.toFixed(1)}s sequence...`);

        // Alert when playback is done
        setTimeout(() => {
            appendMsg("system", "Playback Finished.");
        }, maxDuration * 1000);
    }
</script>

</body>
</html>
